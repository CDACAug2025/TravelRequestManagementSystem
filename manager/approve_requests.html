<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Approve Requests</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>
  <div class="container">
    <div class="header">
      <h2>Requests To Approve</h2>
      <nav>
        <a href="info.html">My Info</a>
        <a href="new_request.html">New Request</a>
        <a href="all_requests.html">My Requests</a>
        <a href="create_employee.html">Create Employee</a>
        <a class="logout" href="#" onclick="logout()">Logout</a>
      </nav>
    </div>
    <div id="tableArea" class="card">
      <div class="card-header">
        <h3 class="card-title">Pending Approval Requests</h3>
      </div>
      <!-- Table content will be inserted here by JavaScript -->
    </div>
  </div>
  <script src="../js/mock_data.js"></script>
  <script src="../js/shared.js"></script>
  <script>
  (function () {
    const u = getLoggedIn();
    if (!u) { 
      location = '/index.html'; 
      return; 
    }

    const data = getStoredData();

    // Filter requests assigned to this manager
    const myPending = data.requests.filter(r => 
      r.approver_id === u.employee_id ||
      ((findEmployeeById(r.employee_id) || {}).manager_id === u.employee_id)
    );

    const el = document.getElementById('tableArea');

    if (!myPending.length) { 
      el.innerHTML += '<p class="message info">No requests pending approval.</p>'; 
      return; 
    }

    // Build table
    let html = `
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Employee</th>
            <th>Date</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Est Cost</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
    `;

    myPending.forEach(r => {
      const emp = findEmployeeById(r.employee_id);
      const statusClass = `status-${r.status.toLowerCase()}`;
      html += `
        <tr id="row${r.request_id}">
          <td>${r.request_id}</td>
          <td>${emp.first_name} ${emp.last_name}</td>
          <td>${r.request_date}</td>
          <td>${r.reason}</td>
          <td id="st${r.request_id}">
            <span class="status-badge ${statusClass}">${r.status}</span>
          </td>
          <td>â‚¹${r.estimated_cost.toFixed(2)}</td>
          <td class="actions">
            <button onclick="updateStatus(${r.request_id}, true)" class="btn success small">Approve</button>
            <button onclick="updateStatus(${r.request_id}, false)" class="btn danger small">Reject</button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    el.innerHTML += html;

    // Simple function to visually change status only
    window.updateStatus = function (id, approve) {
      const cell = document.getElementById('st' + id);
      const newStatus = approve ? 'APPROVED' : 'REJECTED';
      const statusClass = `status-${newStatus.toLowerCase()}`;
      cell.innerHTML = `<span class="status-badge ${statusClass}">${newStatus}</span>`;

      // Optional confirmation message
      const message = document.createElement('div');
      message.className = `message ${approve ? 'success' : 'error'}`;
      message.textContent = `Request #${id} ${approve ? 'approved' : 'rejected'}. (Not saved)`;
      document.getElementById('tableArea').appendChild(message);
      setTimeout(() => message.remove(), 3000);
    };
  })();
</script>

</body>

</html>